/*
  Teem: Tools to process and visualize scientific data and images              
  Copyright (C) 2010, 2009, 2008 Thomas Schultz
  Copyright (C) 2010, 2009, 2008 Gordon Kindlmann

  This library is free software; you can redistribute it and/or
  modify it under the terms of the GNU Lesser General Public License
  (LGPL) as published by the Free Software Foundation; either
  version 2.1 of the License, or (at your option) any later version.
  The terms of redistributing and/or modifying this software also
  include exceptions to the LGPL that facilitate static linking.

  This library is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with this library; if not, write to Free Software Foundation, Inc.,
  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
*/

/* Implementation of spherical harmonics and their relation to tensors */

#include "tijk.h"

static const unsigned int _tijk_max_sh_order=6;
/* for order 6, the maximum number of coefficients is 28 */
#define _TIJK_MAX_SH_LEN 28
/* number of coefficients for order i/2 */
static const unsigned int _tijk_sh_len[4]={1,6,15,28};

#define TIJK_EVAL_ESH_BASIS(TYPE, SUF)		\
  int						\
  tijk_eval_esh_basis_##SUF(TYPE *res, int order, TYPE theta, TYPE phi) { \
  TYPE stheta=sin(theta);						\
  TYPE ctheta=cos(theta);						\
  if (order<0)								\
    return -1;								\
  res[0]=1.0/sqrt(4.0*AIR_PI);						\
  if (order<2)								\
    return 0;								\
  res[1]=sqrt(15.0/(16.0*AIR_PI))*stheta*stheta*cos(2*phi);		\
  res[2]=-sqrt(15.0/(4.0*AIR_PI))*ctheta*stheta*cos(phi);			\
  res[3]=sqrt(5.0/(16.0*AIR_PI))*(3.0*ctheta*ctheta-1.0);			\
  res[4]=-sqrt(15.0/(4.0*AIR_PI))*ctheta*stheta*sin(phi);			\
  res[5]=sqrt(15.0/(16.0*AIR_PI))*stheta*stheta*sin(2*phi);		\
  if (order<4)								\
    return 2;								\
  res[6]=sqrt(315.0/(256.0*AIR_PI))*stheta*stheta*stheta*stheta*cos(4*phi); \
  res[7]=-sqrt(315.0/(32.0*AIR_PI))*ctheta*stheta*stheta*stheta*cos(3*phi); \
  res[8]=sqrt(45.0/(64.0*AIR_PI))*(7*ctheta*ctheta-1)*stheta*stheta*cos(2*phi); \
  res[9]=-sqrt(45.0/(32.0*AIR_PI))*(7*ctheta*ctheta*ctheta-3*ctheta)*stheta*cos(phi); \
  res[10]=sqrt(9.0/(256.0*AIR_PI))*(35.0*ctheta*ctheta*ctheta*ctheta-30.0*ctheta*ctheta+3.0); \
  res[11]=-sqrt(45.0/(32.0*AIR_PI))*(7*ctheta*ctheta*ctheta-3*ctheta)*stheta*sin(phi); \
  res[12]=sqrt(45.0/(64.0*AIR_PI))*(7*ctheta*ctheta-1)*stheta*stheta*sin(2*phi); \
  res[13]=-sqrt(315.0/(32.0*AIR_PI))*ctheta*stheta*stheta*stheta*sin(3*phi); \
  res[14]=sqrt(315.0/(256.0*AIR_PI))*stheta*stheta*stheta*stheta*sin(4*phi); \
  if (order<6)								\
    return 4;								\
  res[15]=1.0/64.0*sqrt(6006.0/AIR_PI)*stheta*stheta*stheta*stheta*stheta*stheta*cos(6*phi); \
  res[16]=-3.0/32.0*sqrt(2002.0/AIR_PI)*stheta*stheta*stheta*stheta*stheta*ctheta*cos(5*phi); \
  res[17]=3.0/32.0*sqrt(91.0/AIR_PI)*stheta*stheta*stheta*stheta*(11*ctheta*ctheta-1.0)*cos(4*phi); \
  res[18]=-1.0/32.0*sqrt(2730.0/AIR_PI)*stheta*stheta*stheta*(11*ctheta*ctheta*ctheta-3*ctheta)*cos(3*phi); \
  res[19]=1.0/64.0*sqrt(2730.0/AIR_PI)*stheta*stheta*(33*ctheta*ctheta*ctheta*ctheta-18*ctheta*ctheta+1.0)*cos(2*phi); \
  res[20]=-1.0/16.0*sqrt(273.0/AIR_PI)*stheta*(33*ctheta*ctheta*ctheta*ctheta*ctheta-30.0*ctheta*ctheta*ctheta+5*ctheta)*cos(phi); \
  res[21]=1.0/32.0*sqrt(13.0/AIR_PI)*(231*ctheta*ctheta*ctheta*ctheta*ctheta*ctheta-315*ctheta*ctheta*ctheta*ctheta+105*ctheta*ctheta-5.0); \
  res[22]=-1.0/16.0*sqrt(273.0/AIR_PI)*stheta*(33*ctheta*ctheta*ctheta*ctheta*ctheta-30.0*ctheta*ctheta*ctheta+5*ctheta)*sin(phi); \
  res[23]=1.0/64.0*sqrt(2730.0/AIR_PI)*stheta*stheta*(33*ctheta*ctheta*ctheta*ctheta-18*ctheta*ctheta+1.0)*sin(2*phi); \
  res[24]=-1.0/32.0*sqrt(2730.0/AIR_PI)*stheta*stheta*stheta*(11*ctheta*ctheta*ctheta-3*ctheta)*sin(3*phi); \
  res[25]=3.0/32.0*sqrt(91.0/AIR_PI)*stheta*stheta*stheta*stheta*(11*ctheta*ctheta-1.0)*sin(4*phi); \
  res[26]=-3.0/32.0*sqrt(2002.0/AIR_PI)*stheta*stheta*stheta*stheta*stheta*ctheta*sin(5*phi); \
  res[27]=1.0/64.0*sqrt(6006.0/AIR_PI)*stheta*stheta*stheta*stheta*stheta*stheta*sin(6*phi); \
  return 6; /* higher orders currently not implemented */		\
  }

TIJK_EVAL_ESH_BASIS(double, d)
TIJK_EVAL_ESH_BASIS(float, f)

#define TIJK_EVAL_ESH(TYPE, SUF)		\
  TYPE									\
  tijk_eval_esh_##SUF(TYPE *coeffs, int order, TYPE theta, TYPE phi) {	\
    TYPE basis[_TIJK_MAX_SH_LEN];					\
    TYPE res=0.0;							\
    unsigned int i;							\
    if (order!=tijk_eval_esh_basis_##SUF(basis, order, theta, phi))	\
      return 0; /* there has been an error. */				\
    for (i=0; i<_tijk_sh_len[order/2]; i++)				\
      res+=basis[i]*coeffs[i];						\
    return res;								\
  }

TIJK_EVAL_ESH(double, d)
TIJK_EVAL_ESH(float, f)

#define TIJK_ESH_SP(TYPE, SUF)				\
  TYPE							\
  tijk_esh_sp_##SUF(TYPE *A, TYPE *B, int order) {	\
    TYPE res=0.0;					\
    if (order<=(int)_tijk_max_sh_order) {		\
      unsigned int i;					\
      for (i=0; i<_tijk_sh_len[order/2]; i++) {		\
	res+=A[i]*B[i];					\
      }							\
    }							\
    return res;						\
  }

TIJK_ESH_SP(double, d)
TIJK_ESH_SP(float, f)

/* conversion matrices computed in Mathematica, stored in double precision */
static const double _tijk_sym2esh_o2[6*6] ={
  1.1816359006036771806, 0, 0, 1.1816359006036771806, 0, 1.1816359006036771806, 
  0.9152912328637688999, 0, 0, -0.9152912328637688999, 0, 0, 
  0, 0, -1.8305824657275377998, 0, 0, 0, 
  -0.52844363968080143579, 0, 0, -0.52844363968080143579, 0, 1.0568872793616028716, 
  0, 0, 0, 0, -1.8305824657275377998, 0, 
  0, 1.8305824657275377998, 0, 0, 0, 0
};
static const double _tijk_esh2sym_o2[6*6] ={
  0.28209479177387819515, 0.54627421529603958916, 0, -0.31539156525252004526, 0, 0, 
  0, 0, 0, 0, 0, 0.54627421529603958916, 
  0, 0, -0.54627421529603958916, 0, 0, 0, 
  0.28209479177387819515, -0.54627421529603958916, 0, -0.31539156525252004526, 0, 0, 
  0, 0, 0, 0, -0.54627421529603958916, 0, 
  0.28209479177387819515, 0, 0, 0.63078313050504009052, 0, 0
};
static const double _tijk_sym2esh_o4[15*15] ={
  0.70898154036220639718, 0, 0, 1.4179630807244127944, 0, 1.4179630807244127944, 0, 0, 0, 0, 0.70898154036220639718, 0, 1.4179630807244127944, 0, 0.70898154036220639718, 
  0.78453534245465905705, 0, 0, 0, 0, 0.78453534245465905705, 0, 0, 0, 0, -0.78453534245465905705, 0, -0.78453534245465905705, 0, 0, 
  0, 0, -1.5690706849093181141, 0, 0, 0, 0, -1.5690706849093181141, 0, -1.5690706849093181141, 0, 0, 0, 0, 0, 
  -0.45295169115497263546, 0, 0, -0.90590338230994527091, 0, 0.45295169115497263546, 0, 0, 0, 0, -0.45295169115497263546, 0, 0.45295169115497263546, 0, 0.90590338230994527091, 
  0, 0, 0, 0, -1.5690706849093181141, 0, 0, 0, 0, 0, 0, -1.5690706849093181141, 0, -1.5690706849093181141, 0, 
  0, 1.5690706849093181141, 0, 0, 0, 0, 1.5690706849093181141, 0, 1.5690706849093181141, 0, 0, 0, 0, 0, 0, 
  0.1997329217870320861, 0, 0, -1.1983975307221925721, 0, 0, 0, 0, 0, 0, 0.1997329217870320861, 0, 0, 0, 0, 
  0, 0, -0.56493001368725082045, 0, 0, 0, 0, 1.6947900410617524614, 0, 0, 0, 0, 0, 0, 0, 
  -0.15098389705165754515, 0, 0, 0, 0, 0.90590338230994538193, 0, 0, 0, 0, 0.15098389705165754515, 0, -0.90590338230994538193, 0, 0, 
  0, 0, 0.64057042473119185644, 0, 0, 0, 0, 0.64057042473119185644, 0, -0.85409389964158910491, 0, 0, 0, 0, 0, 
  0.10128307719460090397, 0, 0, 0.20256615438920180794, 0, -0.81026461755680723176, 0, 0, 0, 0, 0.10128307719460090397, 0, -0.81026461755680723176, 0, 0.27008820585226911426, 
  0, 0, 0, 0, 0.64057042473119185644, 0, 0, 0, 0, 0, 0, 0.64057042473119185644, 0, -0.85409389964158910491, 0, 
  0, -0.3019677941033150903, 0, 0, 0, 0, -0.3019677941033150903, 0, 1.8118067646198907639, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -1.6947900410617524614, 0, 0, 0, 0, 0, 0, 0.56493001368725082045, 0, 0, 0, 
  0, 0.79893168714812834441, 0, 0, 0, 0, -0.79893168714812834441, 0, 0, 0, 0, 0, 0, 0, 0
};
static const double _tijk_esh2sym_o4[15*15] ={
  0.28209479177387819515, 0.54627421529603970018, 0, -0.31539156525252004526, 0, 0, 0.62583573544917614484, 0, -0.47308734787878004013, 0, 0.31735664074561298342, 0, 0, 0, 0, 
  0, 0, 0, 0, 0, 0.27313710764801985009, 0, 0, 0, 0, 0, 0, -0.23654367393939002007, 0, 0.62583573544917614484, 
  0, 0, -0.27313710764801979458, 0, 0, 0, 0, -0.44253269244498261159, 0, 0.50178490766796690625, 0, 0, 0, 0, 0, 
  0.094031597257959328995, -2.6239092990136782376e-17, 0, -0.10513052175084000583, 0, 0, -0.62583573544917614484, 0, -1.1695830935687379082e-17, 0, 0.10578554691520429543, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.091045702549339968535, 0, 0, 0, 0, 0, 0, 0.16726163588932230208, 0, -0.44253269244498261159, 0, 
  0.094031597257959398384, 0.091045702549339926901, 0, 0.052565260875419995978, 0, 0, 9.2621981986301462932e-18, 0, 0.47308734787878004013, 0, -0.42314218766081729273, 0, 0, 0, 0, 
  -0, -0, -0, -0, -0, 0.27313710764801979458, -0, -0, 0, 0, 0, 0, -0.23654367393939002007, 0, -0.62583573544917614484, 
  0, 0, -0.091045702549339954657, 0, 0, 0, 0, 0.44253269244498261159, 0, 0.16726163588932227433, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, 0, 0.091045702549339926901, 0, 0, 0, 0, 0, 0, 0.47308734787878004013, 0, 0, 
  0, 0, -0.27313710764801979458, 0, 0, 0, 0, 0, 0, -0.66904654355728920834, 0, 0, 0, 0, 0, 
  0.28209479177387819515, -0.54627421529603958916, 0, -0.31539156525252004526, 0, 0, 0.62583573544917614484, 0, 0.47308734787878004013, 0, 0.31735664074561298342, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.27313710764801979458, 0, 0, 0, 0, 0, 0, 0.50178490766796690625, 0, 0.44253269244498261159, 0, 
  0.094031597257959370628, -0.091045702549339926901, 0, 0.052565260875420016795, 0, 0, 9.262198198630141671e-18, 0, -0.47308734787878004013, 0, -0.42314218766081729273, 0, 0, 0, 0, 
  -0, -0, -0, -0, -0.27313710764801979458, -0, -0, -0, 0, 0, 0, -0.66904654355728920834, 0, 0, 0, 
  0.28209479177387819515, 4.5022398477899912361e-18, -0, 0.63078313050504009052, -0, 0, 2.7789509525674121332e-17, -0, 2.3394324492700281759e-17, 0, 0.84628437532163458545, 0, 0, 0, 0
};
static const double _tijk_sym2esh_o6[28*28] ={
  0.50641538597300450597, 0, 0, 1.5192461579190135179, 0, 1.5192461579190135179, 0, 0, 0, 0, 1.5192461579190135179, 0, 3.0384923158380270358, 0, 1.5192461579190135179, 0, 0, 0, 0, 0, 0, 0.50641538597300450597, 0, 1.5192461579190135179, 0, 1.5192461579190135179, 0, 0.50641538597300450597, 
  0.65377945204554921421, 0, 0, 0.65377945204554921421, 0, 1.3075589040910984284, 0, 0, 0, 0, -0.65377945204554921421, 0, 0, 0, 0.65377945204554921421, 0, 0, 0, 0, 0, 0, -0.65377945204554921421, 0, -1.3075589040910984284, 0, -0.65377945204554921421, 0, 0, 
  0, 0, -1.3075589040910984284, 0, 0, 0, 0, -2.6151178081821968568, 0, -2.6151178081821968568, 0, 0, 0, 0, 0, 0, -1.3075589040910984284, 0, -2.6151178081821968568, 0, -1.3075589040910984284, 0, 0, 0, 0, 0, 0, 0, 
  -0.37745974262914383512, 0, 0, -1.1323792278874316164, 0, 0, 0, 0, 0, 0, -1.1323792278874316164, 0, 0, 0, 1.1323792278874316164, 0, 0, 0, 0, 0, 0, -0.37745974262914383512, 0, 0, 0, 1.1323792278874316164, 0, 0.75491948525828767025, 
  0, 0, 0, 0, -1.3075589040910984284, 0, 0, 0, 0, 0, 0, -2.6151178081821968568, 0, -2.6151178081821968568, 0, 0, 0, 0, 0, 0, 0, 0, -1.3075589040910984284, 0, -2.6151178081821968568, 0, -1.3075589040910984284, 0, 
  0, 1.3075589040910984284, 0, 0, 0, 0, 2.6151178081821968568, 0, 2.6151178081821968568, 0, 0, 0, 0, 0, 0, 1.3075589040910984284, 0, 2.6151178081821968568, 0, 1.3075589040910984284, 0, 0, 0, 0, 0, 0, 0, 0, 
  0.27236307516413466034, 0, 0, -1.3618153758206730242, 0, 0.27236307516413466034, 0, 0, 0, 0, -1.3618153758206730242, 0, -1.634178450984807851, 0, 0, 0, 0, 0, 0, 0, 0, 0.27236307516413466034, 0, 0.27236307516413466034, 0, 0, 0, 0, 
  0, 0, -0.77035910957352382589, 0, 0, 0, 0, 1.5407182191470476518, 0, -0.77035910957352382589, 0, 0, 0, 0, 0, 0, 2.3110773287205716997, 0, 2.3110773287205716997, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
  -0.20588713234316941003, 0, 0, -0.20588713234316941003, 0, 1.0294356617158468836, 0, 0, 0, 0, 0.20588713234316941003, 0, 0, 0, 1.2353227940590163492, 0, 0, 0, 0, 0, 0, 0.20588713234316941003, 0, -1.0294356617158468836, 0, -1.2353227940590163492, 0, 0, 
  0, 0, 0.8735051246334434305, 0, 0, 0, 0, 1.747010249266886861, 0, -0.29116837487781449534, 0, 0, 0, 0, 0, 0, 0.8735051246334434305, 0, -0.29116837487781449534, 0, -1.1646734995112579814, 0, 0, 0, 0, 0, 0, 0, 
  0.13811328708354669859, 0, 0, 0.41433986125064004025, 0, -0.96679300958482672357, 0, 0, 0, 0, 0.41433986125064004025, 0, -1.9335860191696534471, 0, -0.73660419777891572579, 0, 0, 0, 0, 0, 0, 0.13811328708354669859, 0, -0.96679300958482672357, 0, -0.73660419777891572579, 0, 0.3683020988894578629, 
  0, 0, 0, 0, 0.8735051246334434305, 0, 0, 0, 0, 0, 0, 1.747010249266886861, 0, -0.29116837487781449534, 0, 0, 0, 0, 0, 0, 0, 0, 0.8735051246334434305, 0, -0.29116837487781449534, 0, -1.1646734995112579814, 0, 
  0, -0.41177426468633882006, 0, 0, 0, 0, -0.82354852937267764013, 0, 2.0588713234316937672, 0, 0, 0, 0, 0, 0, -0.41177426468633882006, 0, 2.0588713234316937672, 0, 2.4706455881180326983, 0, 0, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -2.3110773287205716997, 0, 0, 0, 0, 0, 0, -1.5407182191470476518, 0, -2.3110773287205716997, 0, 0, 0, 0, 0, 0, 0, 0, 0.77035910957352382589, 0, 0.77035910957352382589, 0, 0, 0, 
  0, 1.0894523006565386414, 0, 0, 0, 0, 0, 0, 1.0894523006565386414, 0, 0, 0, 0, 0, 0, -1.0894523006565386414, 0, -1.0894523006565386414, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
  0.045741696509788543068, 0, 0, -0.68612544764682814602, 0, 0, 0, 0, 0, 0, 0.68612544764682814602, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.045741696509788543068, 0, 0, 0, 0, 0, 0, 
  0, 0, -0.15845388475869950917, 0, 0, 0, 0, 1.5845388475869950362, 0, 0, 0, 0, 0, 0, 0, 0, -0.7922694237934975181, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
  -0.033782481739884073768, 0, 0, 0.16891240869942036884, 0, 0.33782481739884073768, 0, 0, 0, 0, 0.16891240869942036884, 0, -2.0269489043930444261, 0, 0, 0, 0, 0, 0, 0, 0, -0.033782481739884073768, 0, 0.33782481739884073768, 0, 0, 0, 0, 
  0, 0, 0.18503427297440877553, 0, 0, 0, 0, -0.37006854594881755105, 0, -0.49342472793175679024, 0, 0, 0, 0, 0, 0, -0.5551028189232264376, 0, 1.4802741837952702042, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
  0.03083904549573479939, 0, 0, 0.03083904549573479939, 0, -0.49342472793175679024, 0, 0, 0, 0, -0.03083904549573479939, 0, 0, 0, 0.49342472793175679024, 0, 0, 0, 0, 0, 0, -0.03083904549573479939, 0, 0.49342472793175679024, 0, -0.49342472793175679024, 0, 0, 
  0, 0, -0.19504324926415683716, 0, 0, 0, 0, -0.39008649852831367433, 0, 0.78017299705662734866, 0, 0, 0, 0, 0, 0, -0.19504324926415683716, 0, 0.78017299705662734866, 0, -0.31206919882265093946, 0, 0, 0, 0, 0, 0, 0, 
  -0.021280963179598540863, 0, 0, -0.063842889538795632998, 0, 0.38305733723277379799, 0, 0, 0, 0, -0.063842889538795632998, 0, 0.76611467446554759597, 0, -0.51074311631036506398, 0, 0, 0, 0, 0, 0, -0.021280963179598540863, 0, 0.38305733723277379799, 0, -0.51074311631036506398, 0, 0.068099082174715330762, 
  0, 0, 0, 0, -0.19504324926415683716, 0, 0, 0, 0, 0, 0, -0.39008649852831367433, 0, 0.78017299705662734866, 0, 0, 0, 0, 0, 0, 0, 0, -0.19504324926415683716, 0, 0.78017299705662734866, 0, -0.31206919882265093946, 0, 
  0, 0.061678090991469598781, 0, 0, 0, 0, 0.12335618198293919756, 0, -0.98684945586351358049, 0, 0, 0, 0, 0, 0, 0.061678090991469598781, 0, -0.98684945586351358049, 0, 0.98684945586351358049, 0, 0, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, 0.5551028189232264376, 0, 0, 0, 0, 0, 0, 0.37006854594881755105, 0, -1.4802741837952702042, 0, 0, 0, 0, 0, 0, 0, 0, -0.18503427297440877553, 0, 0.49342472793175679024, 0, 0, 0, 
  0, -0.13512992695953629507, 0, 0, 0, 0, 0, 0, 1.3512992695953629507, 0, 0, 0, 0, 0, 0, 0.13512992695953629507, 0, -1.3512992695953629507, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.7922694237934975181, 0, 0, 0, 0, 0, 0, 1.5845388475869950362, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.15845388475869950917, 0, 0, 0, 0, 0, 
  0, 0.27445017905873125841, 0, 0, 0, 0, -0.91483393019577097238, 0, 0, 0, 0, 0, 0, 0, 0, 0.27445017905873125841, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
};
static const double _tijk_esh2sym_o6[28*28] ={
  0.28209479177387813964, 0.54627421529603947814, -0, -0.31539156525252010077, 0, 0, 0.62583573544917625586, 0, -0.47308734787877981809, 0, 0.31735664074561292791, 0, 0, 0, 0, 0.68318410519191441477, -0, -0.50456490072872428598, -0, 0.46060262975746169012, -0, -0.3178460113381422758, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, 0, 0.1820914050986798538, 0, 0, 0, 0, 0, 0, -0.15769578262626005039, 0, 0.41722382363278409656, 0, 0, 0, 0, 0, 0, 0, 0, 0.15353420991915392446, 0, -0.33637660048581613514, 0, 0.68318410519191441477, 
  0, 0, -0.1820914050986798538, 0, 0, 0, 0, -0.29502179496332175956, 0, 0.33452327177864454866, 0, 0, 0, 0, 0, 0, -0.39443652703862541742, 0, 0.46060262975746169012, 0, -0.48551780209894301876, 0, 0, 0, 0, 0, 0, 0, 
  0.056418958354775637642, 0.03641828101973600823, 0, -0.063078313050504070114, 0, 0, -0.20861191181639207604, 0, -0.031539156525252097507, 0, 0.063471328149122610562, 0, 0, 0, 0, -0.68318410519191441477, 0, 0.16818830024290809533, 0, 0.030706841983830814036, 0, -0.063569202267628480141, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.036418281019735959658, 0, 0, 0, 0, 0, 0, 0.066904654355728898629, 0, -0.17701307697799306684, 0, 0, 0, 0, 0, 0, 0, 0, -0.097103560419788570446, 0, 0.27636157785447712509, 0, -0.3944365270386253064, 0, 
  0.056418958354775700093, 0.072836562039471974828, 0, 8.9555099447302666249e-17, 0, 0, 0.041722382363278368023, 0, 0.15769578262625988385, 0, -0.14809976568128604968, 0, 0, 0, 0, 8.2399365108898336985e-18, 0, 0.33637660048581619066, 0, -0.49130947174129246946, 0, 0.38141521360577063104, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, 0, 0.10925484305920790673, 0, 0, 0, 0, 0, 0, -0.094617469575755980271, 0, 9.9611074597105719874e-19, 0, 0, 0, 0, 0, 0, 0, 0, 0.092120525951492338024, 0, 8.0230960763927328117e-18, 0, -0.68318410519191441477, 
  0, 0, -0.036418281019735994353, 0, 0, 0, 0, 0.059004358992664346362, 0, 0.066904654355728898629, 0, 0, 0, 0, 0, 0, 0.3944365270386253064, 0, -0.092120525951492393535, 0, -0.097103560419788514935, 0, 0, 0, 0, 0, 0, 0, 
  0, 0, -0, 0, 0, 0.036418281019735987414, 0, 0, 0, 0, 0, 0, 0.078847891313130025193, 0, 0.041722382363278409656, 0, -0, 0, -0, 0, -0, 0, 0, -0.24565473587064623473, 0, 0.33637660048581613514, 0, 0, 
  0, 0, -0.10925484305920793449, 0, 0, 0, 0, -0.088506538488996491787, 0, -0.033452327177864449315, 0, 0, 0, 0, 0, 0, 2.6319007737085620136e-17, 0, -0.36848210380596935209, 0, 0.5826213625187315337, 0, 0, 0, 0, 0, 0, 0, 
  0.056418958354775637642, -0.03641828101973600823, 0, -0.063078313050504000725, 0, 0, -0.20861191181639210379, 0, 0.031539156525251986485, 0, 0.063471328149122596685, 0, 0, 0, 0, 0.68318410519191441477, 0, 0.16818830024290809533, 0, -0.030706841983830793219, 0, -0.063569202267628466263, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.036418281019736042925, 0, 0, 0, 0, 0, 0, 0.06690465435572895414, 0, -0.059004358992664346362, 0, 0, 0, 0, 0, 0, 0, 0, -0.097103560419788625957, 0, 0.092120525951492338024, 0, 0.3944365270386253064, 0, 
  0.018806319451591866493, 1.0110185258427328847e-17, 0, -1.3230654636112171296e-17, 0, 0, -0.0417223823632783819, 0, 1.3002294553532411925e-16, 0, -0.049366588560428713295, 0, 0, 0, 0, -1.3356015512305807746e-17, 0, -0.33637660048581619066, 0, -1.5700602710305711085e-17, 0, 0.12713840453525690477, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.036418281019735904147, 0, 0, 0, 0, 0, 0, -0.011150775725954853446, 0, -0.088506538488996519543, 0, 0, 0, 0, 0, 0, 0, 0, 0.19420712083957714089, 0, -0.36848210380596946312, 0, 2.1900883884207189567e-17, 0, 
  0.056418958354775637642, 0.036418281019735987414, 0, 0.063078313050504000725, 0, 0, -3.4196600136376111153e-18, 0, 0.1892349391515119883, 0, -0.11283791670955127528, 0, 0, 0, 0, -2.5949050786116869342e-18, 0, 2.7570180441496557009e-18, 0, 0.49130947174129246946, 0, -0.50855361814102739704, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, 0, 0.1820914050986798538, 0, 0, 0, 0, 0, 0, -0.15769578262626005039, 0, -0.41722382363278409656, 0, 0, 0, 0, 0, 0, 0, 0, 0.15353420991915392446, 0, 0.33637660048581613514, 0, 0.68318410519191441477, 
  -0, 0, -0.036418281019735987414, 0, 0, 0, -0, 0.17701307697799303909, -0, 0.066904654355728884751, -0, 0, 0, 0, 0, 0, -0.3944365270386253064, 0, -0.27636157785447706958, 0, -0.097103560419788570446, 0, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, 0, 0.036418281019735959658, 0, 0, 0, 0, 0, 0, 0.078847891313130025193, 0, -0.041722382363278409656, 0, 0, 0, 0, 0, 0, 0, 0, -0.24565473587064623473, 0, -0.33637660048581613514, 0, 0, 
  0, 0, -0.036418281019735924964, 0, 0, 0, 0, 0.08850653848899653342, 0, -0.011150775725954797934, 0, 0, 0, 0, 0, 0, -1.1722935989999516693e-17, 0, 0.36848210380596940761, 0, 0.19420712083957716865, 0, 0, 0, 0, 0, 0, 0, 
  -0, -0, -0, -0, -0, 0.036418281019735966597, -0, -0, -0, -0, -0, -0, 0.18923493915151196054, -0, -1.9913267072906534227e-18, -0, -0, -0, -0, -0, -0, -0, -0, 0.49130947174129246946, 0, -1.6054589175247916872e-17, 0, 0, 
  0, 0, -0.1820914050986798538, 0, 0, 0, 0, -6.4878668978875960741e-17, 0, -0.44603102903819275005, 0, 0, 0, 0, 0, 0, 1.3271784590120033334e-17, 0, 3.4095831958807153212e-17, 0, -0.77682848335830878561, 0, 0, 0, 0, 0, 0, 0, 
  0.28209479177387813964, -0.54627421529603947814, -0, -0.31539156525252015628, -0, -0, 0.62583573544917625586, -0, 0.47308734787878015116, -0, 0.31735664074561292791, -0, -0, -0, -0, -0.68318410519191441477, -0, -0.50456490072872428598, -0, -0.46060262975746169012, -0, -0.3178460113381422758, -0, -0, 0, 0, 0, 0, 
  -0, -0, -0, -0, -0.18209140509867988156, -0, -0, -0, -0, -0, -0, 0.33452327177864449315, 0, 0.29502179496332175956, 0, -0, -0, -0, -0, -0, -0, -0, -0.48551780209894290774, -0, -0.46060262975746180114, 0, -0.3944365270386253064, 0, 
  0.056418958354775693154, -0.072836562039471988705, 0, 8.9555099447302666249e-17, 0, 0, 0.0417223823632783819, 0, -0.15769578262626013365, 0, -0.14809976568128604968, 0, 0, 0, 0, 1.4203048459560108085e-17, 0, 0.33637660048581613514, 0, 0.49130947174129246946, 0, 0.38141521360577063104, 0, 0, 0, 0, 0, 0, 
  0, 0, -0, 0, -0.10925484305920793449, 0, 0, 0, 0, 0, 0, -0.033452327177864449315, 0, 0.088506538488996519543, 0, 0, -0, 0, -0, 0, -0, 0, 0.5826213625187315337, 0, 0.36848210380596946312, 0, -2.1900883884207189567e-17, 0, 
  0.056418958354775637642, -0.036418281019735987414, 0, 0.063078313050503986847, 0, 0, -3.4113257779765173673e-18, 0, -0.1892349391515119883, 0, -0.11283791670955127528, 0, 0, 0, 0, -1.4522307270911557893e-17, 0, 2.7502987685461758766e-18, 0, -0.49130947174129246946, 0, -0.50855361814102739704, 0, 0, 0, 0, 0, 0, 
  0, 0, 0, 0, -0.18209140509867982605, -0, 0, 0, 0, 0, 0, -0.44603102903819269454, -0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -0.77682848335830867459, -0, 0, 0, 0, 0, 
  0.28209479177387813964, 2.9630111695848276965e-22, 0, 0.63078313050504009052, 0, 0, -4.080980515248682738e-17, 0, 1.5216940301200840144e-17, 0, 0.84628437532163458545, 0, 0, 0, 0, 6.4189546310712161745e-17, 0, 3.2901916779719101699e-17, 0, 3.1736161082457363656e-17, 0, 1.017107236282054572, 0, 0, 0, 0, 0, 0
};

#define TIJK_3D_SYM_TO_ESH(TYPE, SUF)					\
  int									\
  tijk_3d_sym_to_esh_##SUF(TYPE *res, const TYPE *ten,			\
			   const tijk_type *type) {			\
    const double *m; /* conversion matrix */				\
    unsigned int i, j, n;						\
    n=type->num;							\
    if (type==tijk_2o3d_sym) {						\
      m=_tijk_sym2esh_o2;						\
    } else if (type==tijk_4o3d_sym) {					\
      m=_tijk_sym2esh_o4;						\
    } else if (type==tijk_6o3d_sym) {					\
      m=_tijk_sym2esh_o6;						\
    } else {								\
      return -1; /* cannot do conversion */				\
    }									\
    for (i=0; i<n; i++) {						\
      res[i]=0;								\
      for (j=0; j<n; j++) {						\
	res[i]+=m[n*i+j]*ten[j];					\
      }									\
    }									\
    return type->order;							\
  }

TIJK_3D_SYM_TO_ESH(double, d)
TIJK_3D_SYM_TO_ESH(float, f)

#define TIJK_ESH_TO_3D_SYM(TYPE, SUF)					\
  const tijk_type*							\
  tijk_esh_to_3d_sym_##SUF(TYPE *res, const TYPE *sh, int order) {	\
    const double *m; /* conversion matrix */				\
    const tijk_type *type;						\
    unsigned int i, j, n;						\
    switch (order) {							\
    case 2:								\
      m=_tijk_esh2sym_o2;						\
      type=tijk_2o3d_sym;						\
      break;								\
    case 4:								\
      m=_tijk_esh2sym_o4;						\
      type=tijk_4o3d_sym;						\
      break;								\
    case 6:								\
      m=_tijk_esh2sym_o6;						\
      type=tijk_6o3d_sym;						\
      break;								\
    default:								\
      return NULL; /* cannot do the conversion */			\
    }									\
    n=_tijk_sh_len[order/2];						\
    for (i=0; i<n; i++) {						\
      res[i]=0;								\
      for (j=0; j<n; j++) {						\
	res[i]+=m[n*i+j]*sh[j];						\
      }									\
    }									\
    return type;							\
  }

TIJK_ESH_TO_3D_SYM(double, d)
TIJK_ESH_TO_3D_SYM(float, f)
